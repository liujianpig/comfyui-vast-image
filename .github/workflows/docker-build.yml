# 工作流名称：构建并推送ComfyUI Docker镜像
name: Build and Push ComfyUI Docker Image

# 触发条件：
# 1. 推送到main/master分支时触发
# 2. 手动触发（Actions页面点击"Run workflow"）
on:
  push:
    branches: [ main, master ]
    paths:
      - 'Dockerfile'
      - 'torch_whl/**'
      - 'models/**'
      - '.github/workflows/docker-build.yml'
  workflow_dispatch: # 允许手动触发

# 定义作业：构建并推送镜像
jobs:
  build-and-push:
    runs-on: ubuntu-latest # 使用GitHub的Ubuntu云服务器
    permissions:
      contents: read       # 读取仓库代码权限
      packages: write      # 推送镜像权限
      id-token: write      # 可选：用于镜像仓库身份验证

    steps:
      # 步骤1：拉取仓库代码（含Git LFS大文件）
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: true                # 必须开启，拉取LFS管理的模型/whl包
          fetch-depth: 0           # 拉取完整历史（避免LFS拉取失败）

      # 步骤2：设置Docker Buildx（支持多平台构建、缓存优化）
      - name: Set Up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          install: true # 安装最新版Buildx

      # 步骤3：登录Docker Hub（核心：替换为你的镜像仓库）
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }} # 仓库Secrets中的Docker用户名
          password: ${{ secrets.DOCKER_HUB_TOKEN }}   # 仓库Secrets中的Docker访问令牌

      # 步骤4：构建并推送Docker镜像
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .                                   # 构建上下文（仓库根目录）
          push: true                                    # 推送到镜像仓库
          platforms: linux/amd64                        # 适配codewithgpu的AMD64架构
          tags: |                                       # 镜像标签（替换为你的Docker用户名）
            liujianpig/comfyui-vast-image:latest
            liujianpig/comfyui-vast-image:${{ github.sha }} # 按提交哈希打标签（版本追溯）
          # 缓存优化（加速重复构建）
          cache-from: type=registry,ref=liujianpig/comfyui-vast-image:buildcache
          cache-to: type=registry,ref=liujianpig/comfyui-vast-image:buildcache,mode=max
          # 构建参数（可选：传递给Dockerfile）
          build-args: |
            TORCH_CUDA_ARCH_LIST=8.0;8.6;8.9;9.0       # 适配RTX 5070/5090算力

      # 步骤5：输出镜像信息（可选，便于查看）
      - name: Print Image Info
        run: |
          echo "镜像已推送：liujianpig/comfyui-vast-image:latest"
          echo "镜像SHA：${{ github.sha }}"
